# 2026-02-14

## Authenticated LinkedIn Scraping via AgentQL Remote Browser

**What was done:**
- Rewrote `src/lib/agentql.ts` to use AgentQL Remote Browser Sessions instead of the REST API
- Added `playwright-core` for CDP (Chrome DevTools Protocol) WebSocket connections to AgentQL's remote browsers
- LinkedIn `li_at` session cookie is injected into the remote browser for authenticated profile access
- Browser scrolls the full profile page to load lazy content (experience descriptions, skills sections)
- Rendered page text is extracted, stored in `linkedin_raw_profile` (jsonb), and passed to Claude Haiku for structured field extraction
- Updated enrichment dialog to auto-stop on auth errors and show "Auth expired" status
- Re-enrich (GitHub + Claude) now includes stored LinkedIn text as additional context, so fields missed during LinkedIn scrape can be caught on re-enrichment

**Decisions made:**
- **AgentQL Remote Browser + playwright-core** over the AgentQL REST API: The REST API cannot handle authenticated sessions (no cookie/storage_state support). Remote browser sessions spin up a stealth browser on AgentQL's infrastructure; we connect via WebSocket and inject cookies.
- **playwright-core (not full playwright or agentql SDK)**: The `agentql` npm package bundles full Playwright + Chromium (~400MB) which won't work on Vercel serverless. `playwright-core` is just the client (~1.6MB) with no browser binary — the browser runs remotely.
- **Raw page text instead of structured intermediate format**: Previous version had AgentQL extract a structured `LinkedInRawProfile` object. New version stores the raw rendered text. This is more flexible for future re-processing if we add new fields or improve prompts.
- **Environment variable for li_at cookie**: Simple and secure enough for single-admin use. The cookie lasts ~1 year. A UI for managing it can be added later if the team grows.
- **Single Claude call per LinkedIn enrichment**: Claude extracts all structured fields (seniority, languages, frameworks, location, etc.) directly from the raw text in one pass.

**Alternatives considered:**
- **AgentQL REST API with `html` parameter**: Would require fetching LinkedIn HTML ourselves first. LinkedIn is heavily JS-rendered, so a simple `fetch()` with cookies returns a shell page missing most profile data. Rejected.
- **Full `agentql` npm SDK**: Has `page.queryData()` for in-browser extraction, but bundles Playwright + requires Chromium binary. Won't deploy to Vercel. Rejected.
- **Proxycurl API**: Third-party LinkedIn data provider. Additional cost, another vendor dependency. Rejected in favor of self-hosted scraping.
- **LinkedIn Voyager API**: Semi-public JSON endpoints (`/voyager/api/`) that return structured data with `li_at` cookie. Fragile — LinkedIn changes these without notice, and using them may violate ToS. Rejected.
- **Interactive login flow**: Admin logs into LinkedIn via embedded browser window, we capture cookies automatically. Much more complex (2FA, captchas, session management). Deferred — manual cookie paste is fine for now.

**Bug fixes in this session:**
- Fixed admin developer profile editing (edit dialog closed without saving). Root cause: cookie-based Supabase client was silently blocked by RLS on UPDATE operations. Switched all admin update functions in `src/lib/admin/actions.ts` to use service client with explicit admin auth checks.

**Gotchas:**
- AgentQL REST API does NOT support authenticated sessions — this is not documented clearly, only mentioned in a LangChain integration note
- Previous unauthenticated scrape produced false data: AgentQL scraped a LinkedIn login wall, Claude then hallucinated structured data from the nonsense page text
- Supabase RLS silently swallows UPDATE failures — PostgREST returns `{ data: null, error: null }` when RLS blocks an update, making it look like success

**Files changed:**
- `src/lib/agentql.ts` — Complete rewrite for authenticated remote browser scraping
- `src/app/api/admin/linkedin-enrich/route.ts` — Updated for text-based extraction
- `src/app/(admin)/admin/developers/linkedin-enrich-dialog.tsx` — Auth error handling
- `src/app/api/admin/re-enrich/route.ts` — Fetches stored LinkedIn text, passes to Claude
- `src/lib/enrichment.ts` — `extractWithClaude` and `reEnrichDeveloper` accept LinkedIn text
- `src/lib/admin/actions.ts` — Switched to service client for admin developer updates
- `package.json` — Added `playwright-core`
- `supabase/migrations/00032_add_linkedin_raw_profile.sql` — jsonb column for raw profile data

## Mobile Dev Setup (Tailscale + Sled)

**What was done:**
- Installed Tailscale (Mac App Store) for mesh VPN between Mac and iPhone — bypasses resort WiFi client isolation
- Installed and configured Sled (mobile Claude Code UI) at `~/Dev/sled`
- Fixed `claude-code-acp` ENOENT error by adding it as a local dependency in `server-client/package.json`
- Disabled Sled HTTP Basic Auth (Tailscale provides network security)
- Created `~/Dev/mobile-dev-start.sh` and `~/Dev/mobile-dev-stop.sh` scripts for one-command start/stop
- Set up VS Code tunnel as alternative: `code tunnel` → `vscode.dev/tunnel/tessas-macbook-prolo/...`

**Gotchas:**
- Tailscale CLI (`brew install tailscale`) only supports userspace networking — can't accept incoming connections. Must use Mac App Store version for proper tun interface.
- Sled's `server-client` spawns `claude-code-acp` via `child_process.spawn()` with `process.execPath` dirname added to PATH. But node lives at `/opt/homebrew/Cellar/node/24.2.0/bin/` while globally-installed npm bins are at `/opt/homebrew/bin/`. Fix: install `@zed-industries/claude-code-acp` as a local dependency.
- Sled requires TWO processes: web UI (port 8787) + local-agent-manager (port 8788). Use `pnpm start` from monorepo root.
- Wrangler needs `--ip 0.0.0.0` flag to be accessible on Tailscale IP, not just localhost.

## LinkedIn Filter for Developer Table

**What was done:**
- Added `has_linkedin` boolean filter (All / Has / Missing) to the admin developer filter panel — same 3-button pattern as `has_github`

**Files changed:**
- `src/types/admin.ts` — Added `has_linkedin` to `DeveloperFilters`
- `src/lib/admin/search-params.ts` — Parse `has_linkedin` param
- `src/lib/admin/queries.ts` — `linkedin_url` null/not-null filter
- `src/components/admin/developer-filter-panel.tsx` — LinkedIn toggle UI
