# 2026-02-14

## Authenticated LinkedIn Scraping via AgentQL Remote Browser

**What was done:**
- Rewrote `src/lib/agentql.ts` to use AgentQL Remote Browser Sessions instead of the REST API
- Added `playwright-core` for CDP (Chrome DevTools Protocol) WebSocket connections to AgentQL's remote browsers
- LinkedIn `li_at` session cookie is injected into the remote browser for authenticated profile access
- Browser scrolls the full profile page to load lazy content (experience descriptions, skills sections)
- Rendered page text is extracted, stored in `linkedin_raw_profile` (jsonb), and passed to Claude Haiku for structured field extraction
- Updated enrichment dialog to auto-stop on auth errors and show "Auth expired" status
- Re-enrich (GitHub + Claude) now includes stored LinkedIn text as additional context, so fields missed during LinkedIn scrape can be caught on re-enrichment

**Decisions made:**
- **AgentQL Remote Browser + playwright-core** over the AgentQL REST API: The REST API cannot handle authenticated sessions (no cookie/storage_state support). Remote browser sessions spin up a stealth browser on AgentQL's infrastructure; we connect via WebSocket and inject cookies.
- **playwright-core (not full playwright or agentql SDK)**: The `agentql` npm package bundles full Playwright + Chromium (~400MB) which won't work on Vercel serverless. `playwright-core` is just the client (~1.6MB) with no browser binary — the browser runs remotely.
- **Raw page text instead of structured intermediate format**: Previous version had AgentQL extract a structured `LinkedInRawProfile` object. New version stores the raw rendered text. This is more flexible for future re-processing if we add new fields or improve prompts.
- **Environment variable for li_at cookie**: Simple and secure enough for single-admin use. The cookie lasts ~1 year. A UI for managing it can be added later if the team grows.
- **Single Claude call per LinkedIn enrichment**: Claude extracts all structured fields (seniority, languages, frameworks, location, etc.) directly from the raw text in one pass.

**Alternatives considered:**
- **AgentQL REST API with `html` parameter**: Would require fetching LinkedIn HTML ourselves first. LinkedIn is heavily JS-rendered, so a simple `fetch()` with cookies returns a shell page missing most profile data. Rejected.
- **Full `agentql` npm SDK**: Has `page.queryData()` for in-browser extraction, but bundles Playwright + requires Chromium binary. Won't deploy to Vercel. Rejected.
- **Proxycurl API**: Third-party LinkedIn data provider. Additional cost, another vendor dependency. Rejected in favor of self-hosted scraping.
- **LinkedIn Voyager API**: Semi-public JSON endpoints (`/voyager/api/`) that return structured data with `li_at` cookie. Fragile — LinkedIn changes these without notice, and using them may violate ToS. Rejected.
- **Interactive login flow**: Admin logs into LinkedIn via embedded browser window, we capture cookies automatically. Much more complex (2FA, captchas, session management). Deferred — manual cookie paste is fine for now.

**Bug fixes in this session:**
- Fixed admin developer profile editing (edit dialog closed without saving). Root cause: cookie-based Supabase client was silently blocked by RLS on UPDATE operations. Switched all admin update functions in `src/lib/admin/actions.ts` to use service client with explicit admin auth checks.

**Gotchas:**
- AgentQL REST API does NOT support authenticated sessions — this is not documented clearly, only mentioned in a LangChain integration note
- Previous unauthenticated scrape produced false data: AgentQL scraped a LinkedIn login wall, Claude then hallucinated structured data from the nonsense page text
- Supabase RLS silently swallows UPDATE failures — PostgREST returns `{ data: null, error: null }` when RLS blocks an update, making it look like success

**Files changed:**
- `src/lib/agentql.ts` — Complete rewrite for authenticated remote browser scraping
- `src/app/api/admin/linkedin-enrich/route.ts` — Updated for text-based extraction
- `src/app/(admin)/admin/developers/linkedin-enrich-dialog.tsx` — Auth error handling
- `src/app/api/admin/re-enrich/route.ts` — Fetches stored LinkedIn text, passes to Claude
- `src/lib/enrichment.ts` — `extractWithClaude` and `reEnrichDeveloper` accept LinkedIn text
- `src/lib/admin/actions.ts` — Switched to service client for admin developer updates
- `package.json` — Added `playwright-core`
- `supabase/migrations/00032_add_linkedin_raw_profile.sql` — jsonb column for raw profile data

## Mobile Dev Setup (Tailscale + Sled)

**What was done:**
- Installed Tailscale (Mac App Store) for mesh VPN between Mac and iPhone — bypasses resort WiFi client isolation
- Installed and configured Sled (mobile Claude Code UI) at `~/Dev/sled`
- Fixed `claude-code-acp` ENOENT error by adding it as a local dependency in `server-client/package.json`
- Disabled Sled HTTP Basic Auth (Tailscale provides network security)
- Created `~/Dev/mobile-dev-start.sh` and `~/Dev/mobile-dev-stop.sh` scripts for one-command start/stop
- Set up VS Code tunnel as alternative: `code tunnel` → `vscode.dev/tunnel/tessas-macbook-prolo/...`

**Gotchas:**
- Tailscale CLI (`brew install tailscale`) only supports userspace networking — can't accept incoming connections. Must use Mac App Store version for proper tun interface.
- Sled's `server-client` spawns `claude-code-acp` via `child_process.spawn()` with `process.execPath` dirname added to PATH. But node lives at `/opt/homebrew/Cellar/node/24.2.0/bin/` while globally-installed npm bins are at `/opt/homebrew/bin/`. Fix: install `@zed-industries/claude-code-acp` as a local dependency.
- Sled requires TWO processes: web UI (port 8787) + local-agent-manager (port 8788). Use `pnpm start` from monorepo root.
- Wrangler needs `--ip 0.0.0.0` flag to be accessible on Tailscale IP, not just localhost.

## Folk Group Removal Fix

**What was done:**
- Fixed "Remove from Group" button in admin Folk enrichment page that hung indefinitely
- Added 10s AbortController timeout per Folk API call on server side
- Added 30s AbortController timeout on client-side fetch
- Moved `setDeleting` cleanup to `finally` block
- Made error banner dismissable instead of replacing the entire table
- Reduced retry count and capped retry-after wait time

**Root cause:**
- No timeouts on either client or server fetch calls — if Folk API was slow or Vercel had connectivity issues, the spinner would spin forever with no feedback

**Files changed:**
- `src/app/api/admin/folk/people/remove-from-group/route.ts` — Server timeouts + retry improvements
- `src/app/(admin)/admin/enrichment/contact-table.tsx` — Client timeout, error UX

## ICP-Based Auto-Matching for Projects

**What was done:**
- Built a weighted scoring engine that matches developers against project ICP criteria
- Added a "Recommended Developers" card to the project detail page showing ranked matches
- Admin can one-click invite matched developers (triggers existing evaluation + email flow)
- Score displayed as color-coded badge with tooltip showing full match breakdown

**Decisions made:**
- **In-memory JS scoring** over Postgres functions: With ~700 developers, fetching all and scoring in TypeScript is instant (<50ms) and much simpler to maintain than PL/pgSQL scoring functions
- **OR-based scoring with weights** over AND-based filtering: The existing match-preview used AND (all criteria must match). For recommendations, developers should rank by how well they match, not be excluded for missing one criterion
- **Weight tiers** (Core: 60, Secondary: 25, Peripheral: 15): Role types, seniority, languages, and experience are the strongest signals. Infrastructure/tooling preferences are secondary
- **Weight redistribution**: When a project only sets a few ICP criteria, weights are redistributed so scores still normalize to 0-100. A project with only `icp_languages` set still produces meaningful rankings

**Alternatives considered:**
- **Postgres scoring function**: More efficient for large datasets but adds migration complexity and is harder to iterate on weights. Rejected — premature optimization at 700 developers
- **Background job / cron-based matching**: Precompute matches when projects are created. Rejected — real-time scoring is fast enough and always reflects latest developer data
- **Separate matching page**: Considered a standalone `/admin/matching` page. Rejected — embedding in the project detail page provides better context (see ICP criteria, then see matches, then see assignments)

**Files changed:**
- `src/lib/admin/icp-matching.ts` — New: scoring engine with weighted criteria
- `src/app/(admin)/admin/projects/[id]/recommended-matches.tsx` — New: recommendation UI component
- `src/lib/admin/queries.ts` — Added `getMatchCandidates()` query
- `src/app/(admin)/admin/projects/[id]/page.tsx` — Wired in matching + component

## LinkedIn Filter for Developer Table

**What was done:**
- Added `has_linkedin` boolean filter (All / Has / Missing) to the admin developer filter panel — same 3-button pattern as `has_github`

**Files changed:**
- `src/types/admin.ts` — Added `has_linkedin` to `DeveloperFilters`
- `src/lib/admin/search-params.ts` — Parse `has_linkedin` param
- `src/lib/admin/queries.ts` — `linkedin_url` null/not-null filter
- `src/components/admin/developer-filter-panel.tsx` — LinkedIn toggle UI

## Full Project Management (Edit + Delete)

**What was done:**
- Expanded `EditProjectDialog` from 6 basic fields to full project editing: basic info, evaluation setup (scope, setup instructions, time-to-value milestone, goals), and all 18 ICP criteria fields
- ICP criteria use the same `MultiSelectFilter` component as the developer filter panel — searchable dropdowns with checkboxes
- Dialog is now wider (`max-w-3xl`) and scrollable for the expanded form
- Added `deleteProject()` server action that cascades through evaluations before deleting the project
- Added red "Delete" button with confirmation dialog on the project detail page header
- `updateProject()` action expanded to accept all ICP fields + evaluation setup fields

**Decisions made:**
- **Reuse `MultiSelectFilter` for ICP editing** over building a new tag-input component: The filter panel's multi-select popover with search is already proven and handles all the option lists. Consistent UX across the app.
- **Scrollable dialog over tabs/accordion**: With ~25 fields spread across 3 sections, a single scrollable form with clear section headers is faster to scan and edit than tabbed navigation. Admin is the only user, so compact over slick.
- **Service client for delete**: Delete needs to cascade through evaluations first, then delete the project. Using service client bypasses RLS (same pattern as other admin mutations).
- **Confirmation dialog for delete**: Destructive action with no undo — uses the existing `ConfirmDialog` component with `destructive` variant.

**Alternatives considered:**
- **Separate page for project editing**: Full-page edit form would give more room but adds navigation overhead. Dialog keeps context (you can see the project info behind it). Rejected.
- **Soft delete (archive)**: Could mark projects as archived instead of deleting. Rejected — admin is single user, hard delete is clearer, and we can add archiving later if needed.
- **Inline editing on the detail page**: Edit fields directly on the project detail card. More complex to implement (each field needs toggle between display/edit mode) for a single-admin app. Rejected.

**Files changed:**
- `src/app/(admin)/admin/projects/[id]/edit-project-dialog.tsx` — Complete rewrite with ICP criteria + evaluation setup
- `src/app/(admin)/admin/projects/[id]/delete-project-button.tsx` — New: delete button with confirmation
- `src/app/(admin)/admin/projects/[id]/page.tsx` — Added DeleteProjectButton import and usage
- `src/lib/admin/actions.ts` — Expanded `updateProject()` type, added `deleteProject()`

## AI-Guided ICP Discovery Wizard

**What was done:**
- Replaced the developer browsing table on the landing page with an AI-guided ICP discovery wizard
- Founders describe their product in a textarea, Claude Haiku analyzes the description and suggests ideal developer profile criteria from predefined option lists
- Three-phase wizard: input (product description) → loading (Claude analysis) → results (editable criteria + developer preview)
- Results phase shows AI-suggested criteria as removable badges with `MultiSelectFilter` to add more values, plus an expandable section for unused criteria
- Developer preview table (up to 8 anonymized profiles) live-updates with 300ms debounce as criteria are edited
- Clicking "Get Evaluations" stores ICP criteria in localStorage and navigates to `/buy`
- Updated checkout form to support both new ICP criteria flow and legacy profile-selection flow (backward compat)
- Updated checkout API to map ICP criteria directly to project `icp_*` columns instead of deriving from profiles
- Product description and URL pre-filled on checkout page from wizard inputs
- Success page clears all new localStorage keys

**Decisions made:**
- **Claude Haiku** over Sonnet: Fast (~1-2s), cheap (~$0.002/call), good enough for constrained option selection. The prompt only allows values from predefined lists, so hallucination risk is minimal.
- **Post-processing validation**: Even though the prompt constrains Claude to predefined values, `validateCriteria()` double-checks every returned value against the option lists. Defense in depth against hallucinated values.
- **In-memory IP rate limiting** (5 req/min): Simple protection against abuse on the public endpoint. No Redis needed at this scale.
- **Reuse existing feed API** for developer preview: `/api/developers/feed` already supports all filter params. The wizard uses the same endpoint with ICP criteria as query params.
- **Reuse `MultiSelectFilter`** for criteria editing: Same searchable multi-select dropdown used in admin filter panel and project edit dialog. Consistent UX.
- **localStorage bridge** between wizard and checkout: Same pattern as existing `bfd_selected_profiles` flow. Three keys: `bfd_icp_criteria`, `bfd_product_description`, `bfd_product_url`.
- **Backward-compatible checkout API**: The `/api/buy/checkout` endpoint accepts either `icpCriteria` (new) or `selectedProfiles` (legacy). When ICP criteria are provided, they map directly to project columns. Legacy flow still derives ICP from union of profile attributes.

**Alternatives considered:**
- **Keep the developer table alongside wizard**: User decided to replace it entirely — the table was overwhelming for founders who don't think in technical filter terms.
- **Show match counts instead of preview**: Rejected — preview of actual anonymized profiles is more compelling and demonstrates the network quality.
- **Let some users skip AI and go straight to filters**: Rejected — everyone goes through AI first, then can edit. This ensures even technical founders get a good starting point.
- **Server-side ICP suggestion (server action)**: Could avoid a public API endpoint, but rate limiting and error handling are cleaner as a REST endpoint. Also, the wizard is a client component that benefits from the fetch pattern.
- **GPT-4o-mini for suggestions**: Anthropic SDK already in the project, and Haiku is comparable in speed/cost. Keeping one AI provider is simpler.

**Files created:**
- `src/types/icp.ts` — Shared types: `IcpCriteria`, `EMPTY_ICP_CRITERIA`, `ICP_CRITERIA_KEYS`, `IcpSuggestResponse`
- `src/app/api/icp/suggest/route.ts` — Claude Haiku ICP suggestion endpoint with rate limiting and validation
- `src/components/marketing/icp-wizard.tsx` — Three-phase wizard component (input → loading → results)

**Files modified:**
- `src/components/marketing/product-preview.tsx` — Swapped `DeveloperFeed` for `IcpWizard`, updated heading copy
- `src/app/buy/checkout-form.tsx` — Dual-mode support (ICP criteria vs legacy profiles), pre-fills from localStorage
- `src/app/api/buy/checkout/route.ts` — Accepts `icpCriteria` field, maps to project ICP columns directly
- `src/app/buy/success/clear-storage.tsx` — Clears `bfd_icp_criteria`, `bfd_product_description`, `bfd_product_url`

## Move Evaluation Goals from Wizard to Checkout

**What was done:**
- Removed challenge/goal checkboxes from the ICP wizard input phase — they don't affect which developers get suggested
- Wizard input is now just Product URL + optional description textarea
- Moved goal selection to the checkout form as a "What do you want to learn?" section with checkbox cards
- Goals are stored as `goals` on the project (same schema column as before)
- Simplified the suggest API to only accept URL + description (no challenges)
- Updated system prompt to remove challenges references

**Decisions made:**
- **Goals at checkout, not wizard**: The goals/challenges don't influence which developers match the ICP criteria. Asking for them during the wizard step was confusing — founders might think their challenge selection affected developer matching. Moving to checkout makes the purpose clear: "what should evaluators focus on?"
- **Schema goal values with readable labels**: Using the same enum values from the projects `goals` column but with clean display labels ("Messaging validation", "Onboarding flow evaluation")

**Files changed:**
- `src/components/marketing/icp-wizard.tsx` — Removed challenges state, checkboxes, and `buildDescription()`. Input is now URL + description
- `src/app/api/icp/suggest/route.ts` — Removed challenges from request body and system prompt
- `src/app/buy/checkout-form.tsx` — Added goal checkboxes section, removed `bfd_icp_challenges` localStorage reading
- `src/app/api/buy/checkout/route.ts` — Changed `challenges` field to `goals`
- `src/app/buy/success/clear-storage.tsx` — Removed `bfd_icp_challenges` cleanup
- `src/components/marketing/product-preview.tsx` — Updated subheading copy

## Auto-Create Company Account on Purchase

**What was done:**
- After Stripe payment, the success page now automatically creates a company user account for the buyer
- Creates `auth.users` entry (via `admin.createUser()`), which triggers `handle_new_user` to create a `profiles` entry
- Creates `company_contacts` record linking the new user to their company
- Updates the project's `created_by` to point to the new company contact
- Success page shows "Your account is ready" card with a "Set Your Password" button (links to forgot-password page)
- Idempotent: checks if a profile with the buyer's email already exists before creating

**Decisions made:**
- **Account creation on success page, not webhook**: The success page is synchronous with page load, so the user sees "account created" immediately. The webhook fires asynchronously and might not have completed when the page renders
- **No password set at creation**: User is created without a password. They use the "forgot password" flow to set one. This avoids generating/emailing temporary passwords and uses existing infrastructure
- **`email_confirm: true`**: The buyer's email is implicitly verified through Stripe payment (they received confirmation emails at that address), so we skip Supabase's email verification step

**Files changed:**
- `src/lib/account/ensure-buyer-account.ts` — New shared utility for idempotent buyer account creation
- `src/app/buy/success/page.tsx` — Uses `ensureBuyerAccount()`, updated UI with "Your account is ready" card
- `src/app/score/[slug]/buy/success/page.tsx` — Same auto-account creation + fixed "cold" copy
- `src/app/buy/checkout-form.tsx` — Updated copy: "Your developer criteria" heading, goals section subtitle, default evaluations to 10

## Claude Code Project Setup Improvements

**What was done:**
- Replaced CLAUDE.md (was describing wrong project — "Growth Operations" marketing skills repo) with accurate project instructions covering stack, commands, architecture, and gotchas
- Created `.claude/settings.json` with pre-approved permissions for common commands (build, lint, supabase, shadcn) and domain fetches
- Reorganized MEMORY.md to remove information now covered by CLAUDE.md, keeping only cross-session preferences, environment-specific setup, and build progress

**Decisions made:**
- **CLAUDE.md for stable project facts** (stack, patterns, gotchas), **MEMORY.md for session preferences** (user workflow prefs, mobile setup, progress tracking): CLAUDE.md is read at every session start and checked into git. MEMORY.md is private and persists across sessions but shouldn't duplicate CLAUDE.md
- **Shared `.claude/settings.json`** (committed) vs **`.claude/settings.local.json`** (gitignored): Shared settings pre-approve commands any contributor would need. Local settings hold personal domain permissions (ClarityFlow, etc.)
- **Pre-approved `npx supabase *`**: Most supabase CLI commands are safe read operations or migrations — pre-approving avoids constant permission prompts

**Alternatives considered:**
- **Hooks for auto-formatting**: Could add PostToolUse hooks to run prettier after edits. Deferred — no formatter configured in the project currently
- **Custom skills for deployment/review workflows**: Could create `.claude/skills/deploy/SKILL.md` etc. Deferred — single developer, not enough repeatable workflows yet to justify
- **More granular bash permissions**: Could pre-approve `git commit *`, `git push`, etc. Decided against — git operations should still require confirmation to avoid accidental pushes

**Files changed:**
- `CLAUDE.md` — Complete rewrite with accurate project context
- `.claude/settings.json` — New: shared permissions for common commands
- `~/.claude/projects/.../memory/MEMORY.md` — Slimmed down, removed CLAUDE.md duplicates

## Vitest Test Harness Setup

**What was done:**
- Added Vitest test framework with 35 tests covering pure business logic (zero external dependencies to mock)
- Three test files: score validation (13 tests), classification maps (5 tests), ICP developer matching engine (17 tests)
- Added `npm test` and `npm run test:watch` scripts
- Updated CLAUDE.md to reference `npm test` as verification command

**Decisions made:**
- **Vitest over Jest**: Native ESM + TypeScript support without extra config. Jest requires `ts-jest` or `@swc/jest`, plus `moduleNameMapper` for the `@/` path alias, plus `transformIgnorePatterns` for Zod v4's ESM-first distribution. Vitest needs 2 devDependencies and 10 lines of config
- **Pure function tests only**: Score validation, classification maps, and ICP matching are the highest-value targets because they're core business logic with no external dependencies. Server action tests (needing Supabase mocking) and API route tests deferred — the framework is now in place for when those are needed
- **Colocated test files** (`*.test.ts` next to source) over `__tests__/` directory: Files that change together live together. Easier for Claude Code to find and update tests alongside source
- **Explicit imports** (`import { describe, it, expect } from "vitest"`) over `globals: true`: Better editor support and makes it clear which test framework is being used
- **Factory helpers with `as` casts** for `Project`/`DeveloperWithProfile`: These types come from database schema generation and have 40+ fields. The matcher only reads ICP-prefixed fields, so factories set those plus use casts. The alternative (satisfying every field) would make factories fragile to schema changes

**Alternatives considered:**
- **Jest**: Industry standard but requires significantly more config for this stack (ESM, TypeScript, path aliases). Rejected
- **@testing-library/react for component tests**: Not needed yet — pure function tests provide the most value per setup cost. Can add later
- **Playwright E2E tests**: `playwright-core` is already a dependency (for AgentQL), but E2E setup is a separate effort. Deferred
- **Coverage thresholds**: Premature for going from 0% to first tests. Can add once coverage is meaningful

**Files created:**
- `vitest.config.ts` — Vitest config with vite-tsconfig-paths plugin
- `src/lib/score/validation.test.ts` — URL transform, localhost/IP/local rejection, email validation
- `src/lib/score/classification.test.ts` — Classification map completeness guard rails
- `src/lib/admin/icp-matching.test.ts` — Weighted scoring, weight redistribution, ranking, limits, exclusion

**Files modified:**
- `package.json` — Added `test`/`test:watch` scripts, `vitest` and `vite-tsconfig-paths` devDependencies
- `CLAUDE.md` — Updated Commands section with `npm test`
